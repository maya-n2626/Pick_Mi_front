<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PickMi - Anonymous Note Throwing</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        overflow-x: hidden;
      }

      .app-container {
        max-width: 412px;
        margin: 20px auto;
        background: #fff;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        min-height: 90vh;
        position: relative;
      }

      .status-bar {
        height: 44px;
        background: linear-gradient(90deg, #000 0%, #333 100%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        color: #fff;
        font-size: 14px;
        font-weight: 500;
      }

      .screen {
        display: none;
        min-height: calc(90vh - 44px);
        position: relative;
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      }

      .screen.active {
        display: block;
      }

      .app-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      }

      .logo {
        font-size: 24px;
        font-weight: 700;
        color: #667eea;
      }

      .nav-button {
        background: none;
        border: none;
        font-size: 16px;
        color: #667eea;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 20px;
        transition: all 0.3s ease;
      }

      .nav-button:hover {
        background: rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
      }

      .auth-container {
        padding: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
      }

      .auth-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 320px;
      }

      .auth-title {
        font-size: 28px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 30px;
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
      }

      .form-input {
        width: 100%;
        padding: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #f8f9fa;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn-primary {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 16px;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: none;
        border: none;
        color: #667eea;
        cursor: pointer;
        font-size: 14px;
        text-decoration: underline;
        margin: 8px;
      }

      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        text-align: center;
        display: none;
      }

      .success-message {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        text-align: center;
      }

      .home-content {
        padding: 20px;
        min-height: calc(90vh - 120px);
      }

      .floating-notes {
        position: relative;
        height: 400px;
        margin: 40px 0;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        overflow: hidden;
      }

      .floating-note {
        position: absolute;
        width: 50px;
        height: 50px;
        background: #ffd54f;
        border-radius: 50% 50% 0 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        animation: float 6s ease-in-out infinite;
      }

      .floating-note:hover {
        transform: scale(1.2);
        z-index: 10;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
        }
        25% {
          transform: translateY(-20px) rotate(5deg);
        }
        50% {
          transform: translateY(-10px) rotate(-5deg);
        }
        75% {
          transform: translateY(-15px) rotate(3deg);
        }
      }

      .action-buttons {
        display: flex;
        gap: 20px;
        margin-top: 20px;
      }

      .fab {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .fab:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
      }

      .map-container {
        width: 100%;
        height: 400px;
        border-radius: 20px;
        overflow: hidden;
        margin: 20px 0;
      }

      .note-editor {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 30px;
        margin: 20px;
      }

      .note-input {
        width: 100%;
        min-height: 200px;
        padding: 20px;
        border: 2px solid #e0e0e0;
        border-radius: 16px;
        font-size: 16px;
        resize: none;
        font-family: inherit;
        background: #f8f9fa;
      }

      .note-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .canvas-container {
        position: relative;
        margin: 20px 0;
      }

      .drawing-canvas {
        border: 2px solid #e0e0e0;
        border-radius: 16px;
        cursor: crosshair;
        background: white;
        width: 100%;
      }

      .canvas-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-top: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
      }

      .admin-panel {
        padding: 20px;
      }

      .admin-section {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .admin-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #eee;
      }

      .btn-danger {
        background: #e53e3e;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn-danger:hover {
        background: #c53030;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .note-content {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 30px;
        margin: 20px;
        max-height: 70vh;
        overflow-y: auto;
      }

      .note-content img {
        max-width: 100%;
        height: auto;
        border-radius: 12px;
        margin: 10px 0;
      }

      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 25px 25px 0 0;
        padding: 15px 0;
        width: 100%;
        max-width: 412px;
        display: flex;
        justify-content: space-around;
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.1);
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 8px;
        border-radius: 12px;
      }

      .nav-item:hover {
        background: rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
      }

      .nav-icon {
        font-size: 20px;
        margin-bottom: 4px;
      }

      .nav-label {
        font-size: 12px;
        color: #666;
      }

      @media (max-width: 480px) {
        .app-container {
          margin: 0;
          border-radius: 0;
          min-height: 100vh;
        }

        .auth-container {
          padding: 20px;
        }

        .auth-card {
          padding: 30px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Status Bar -->
      <div class="status-bar">
        <span id="time">9:41</span>
        <span>PickMi</span>
        <span>🔋 100%</span>
      </div>

      <!-- Login Screen -->
      <div id="login-screen" class="screen active">
        <div class="auth-container">
          <div class="auth-card">
            <h1 class="auth-title">Welcome to PickMi</h1>
            <form id="login-form">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-input"
                  id="login-email"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Password</label>
                <input
                  type="password"
                  class="form-input"
                  id="login-password"
                  required
                />
              </div>
              <div id="login-error" class="error-message"></div>
              <button type="submit" class="btn-primary">Sign In</button>
              <div style="text-align: center">
                <button type="button" class="btn-secondary" id="show-signup">
                  Sign Up
                </button>
                <button type="button" class="btn-secondary" id="show-forgot">
                  Forgot Password?
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Signup Screen -->
      <div id="signup-screen" class="screen">
        <div class="auth-container">
          <div class="auth-card">
            <h1 class="auth-title">Create Account</h1>
            <form id="signup-form">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-input"
                  id="signup-email"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Password</label>
                <input
                  type="password"
                  class="form-input"
                  id="signup-password"
                  required
                />
              </div>
              <div id="signup-error" class="error-message"></div>
              <button type="submit" class="btn-primary">Create Account</button>
              <div style="text-align: center">
                <button type="button" class="btn-secondary" id="back-to-login">
                  Back to Login
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Forgot Password Screen -->
      <div id="forgot-screen" class="screen">
        <div class="auth-container">
          <div class="auth-card">
            <h1 class="auth-title">Reset Password</h1>
            <form id="forgot-form">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-input"
                  id="forgot-email"
                  required
                />
              </div>
              <div id="forgot-error" class="error-message"></div>
              <button type="submit" class="btn-primary">Send Reset Link</button>
              <div style="text-align: center">
                <button
                  type="button"
                  class="btn-secondary"
                  id="back-to-login-2"
                >
                  Back to Login
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Home Screen -->
      <div id="home-screen" class="screen">
        <div class="app-header">
          <div class="logo">PickMi</div>
          <div>
            <button class="nav-button" id="show-map">Map</button>
            <button class="nav-button" id="show-profile">Profile</button>
            <button class="nav-button" id="admin-btn" style="display: none">
              Admin
            </button>
          </div>
        </div>
        <div class="home-content">
          <div class="floating-notes" id="notes-container">
            <!-- Notes will be dynamically added here -->
          </div>
          <div
            class="action-buttons"
            style="display: flex; justify-content: center"
          >
            <button class="fab" id="new-note-btn" title="Create Note">
              📝
            </button>
          </div>
        </div>
      </div>

      <!-- Map Screen -->
      <div id="map-screen" class="screen">
        <div class="app-header">
          <button class="nav-button" id="back-from-map">← Back</button>
          <div class="logo">Map</div>
          <div></div>
        </div>
        <div style="padding: 20px">
          <div class="map-container">
            <div id="map" style="width: 100%; height: 100%"></div>
          </div>
        </div>
      </div>

      <!-- Note Editor Screen -->
      <div id="note-editor-screen" class="screen">
        <div class="app-header">
          <button class="nav-button" id="back-from-editor">← Back</button>
          <div class="logo">New Note</div>
          <button class="nav-button" id="save-note">Save</button>
        </div>
        <div class="note-editor">
          <div style="margin-bottom: 20px">
            <button type="button" class="btn-secondary" id="text-mode">
              Text
            </button>
            <button type="button" class="btn-secondary" id="draw-mode">
              Draw
            </button>
          </div>

          <div id="text-editor" style="display: block">
            <textarea
              id="note-text"
              class="note-input"
              placeholder="Write your note here..."
            ></textarea>
          </div>

          <div id="draw-editor" style="display: none">
            <div class="canvas-container">
              <canvas
                id="drawing-canvas"
                class="drawing-canvas"
                width="320"
                height="240"
              ></canvas>
              <div class="canvas-controls">
                <label>Color:</label>
                <input type="color" id="brush-color" value="#000000" />
                <label>Size:</label>
                <input
                  type="range"
                  id="brush-size"
                  min="1"
                  max="20"
                  value="5"
                />
                <button type="button" class="btn-secondary" id="clear-canvas">
                  Clear
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Note View Screen -->
      <div id="note-view-screen" class="screen">
        <div class="app-header">
          <button class="nav-button" id="back-from-note">← Back</button>
          <div class="logo">Note</div>
          <button class="nav-button" id="delete-note">Delete</button>
        </div>
        <div class="note-content" id="note-content">
          <!-- Note content will be loaded here -->
        </div>
      </div>

      <!-- Profile Screen -->
      <div id="profile-screen" class="screen">
        <div class="app-header">
          <button class="nav-button" id="back-from-profile">← Back</button>
          <div class="logo">Profile</div>
          <button class="nav-button" id="logout-btn">Logout</button>
        </div>
        <div style="padding: 40px">
          <div class="auth-card">
            <h2 style="text-align: center; margin-bottom: 30px">
              Account Settings
            </h2>
            <button
              class="btn-danger"
              id="delete-account-btn"
              style="width: 100%"
            >
              🗑️ Delete Account
            </button>
          </div>
        </div>
      </div>

      <!-- Admin Screen -->
      <div id="admin-screen" class="screen">
        <div class="app-header">
          <button class="nav-button" id="back-from-admin">← Back</button>
          <div class="logo">Admin Panel</div>
          <div></div>
        </div>
        <div class="admin-panel">
          <div class="admin-section">
            <h3>Users</h3>
            <div id="admin-users" class="loading">
              <div class="spinner"></div>
            </div>
          </div>
          <div class="admin-section">
            <h3>Notes</h3>
            <div id="admin-notes" class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCbMIwPY6SqN9WsL7Fvn4E_r_2kpj6CrQY&libraries=places&callback=initMap"
      async
      defer
    ></script>

    <script>
      // Global state management
      const state = {
        currentUser: null,
        currentLocation: { lat: null, lon: null, placeId: null },
        currentNoteId: null,
        isDrawing: false,
        canvas: null,
        ctx: null,
      };

      // API Configuration
      const API_BASE = import.meta.env.VITE_API_URL;

      // Utility functions
      const jwt = () => state.currentUser?.token || "";

      const showScreen = (screenId) => {
        document.querySelectorAll(".screen").forEach((screen) => {
          screen.classList.remove("active");
        });
        document.getElementById(screenId).classList.add("active");
      };

      const showError = (elementId, message) => {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.style.display = "block";
        setTimeout(() => {
          element.style.display = "none";
        }, 5000);
      };

      // API wrapper function
      const apiFetch = async (path, options = {}) => {
        const headers = options.headers || {};
        if (!headers.Authorization && jwt()) {
          headers.Authorization = "Bearer " + jwt();
        }
        if (options.body && !headers["Content-Type"]) {
          headers["Content-Type"] = "application/json";
        }

        try {
          const response = await fetch(API_BASE + path, {
            ...options,
            headers,
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error?.message || response.statusText);
          }

          return response.status !== 204 ? response.json() : {};
        } catch (error) {
          console.error("API Error:", error);
          throw error;
        }
      };

      // Authentication functions
      const authAPI = {
        async signup(email, password) {
          return apiFetch("/api/auth/signup", {
            method: "POST",
            body: JSON.stringify({ email, password }),
          });
        },

        async signin(email, password) {
          const response = await apiFetch("/api/auth/signin", {
            method: "POST",
            body: JSON.stringify({ email, password }),
          });

          state.currentUser = {
            token: response.token,
            user: response.user,
          };

          return response;
        },

        async forgotPassword(email) {
          return apiFetch("/api/auth/forgot-password", {
            method: "POST",
            body: JSON.stringify({ email }),
          });
        },

        async deleteAccount(password) {
          return apiFetch("/api/auth/me", {
            method: "DELETE",
            body: JSON.stringify({ password }),
          });
        },
      };

      // Notes API
      const notesAPI = {
        async createNote(text, drawingData, lat, lon, placeId) {
          return apiFetch("/api/notes", {
            method: "POST",
            body: JSON.stringify({
              content: { text, drawingData },
              location: { latitude: lat, longitude: lon, placeId },
            }),
          });
        },

        async getNearbyNotes(lat, lon, radius = 1000) {
          return apiFetch(
            `/api/notes/nearby?lat=${lat}&lon=${lon}&radius=${radius}`,
          );
        },

        async getNoteContent(id, lat, lon) {
          return apiFetch(`/api/notes/${id}?lat=${lat}&lon=${lon}`);
        },

        async deleteNote(id, lat, lon) {
          return apiFetch(`/api/notes/${id}`, {
            method: "DELETE",
            body: JSON.stringify({
              latitude: Number(lat),
              longitude: Number(lon),
            }),
          });
        },
      };

      // Admin API
      const adminAPI = {
        async getAllUsers() {
          return apiFetch("/api/admin/users");
        },

        async getAllNotes() {
          return apiFetch("/api/admin/notes");
        },

        async deleteUser(userId) {
          return apiFetch(`/api/admin/users/${userId}`, { method: "DELETE" });
        },

        async deleteNoteAsAdmin(noteId) {
          return apiFetch(`/api/admin/notes/${noteId}`, { method: "DELETE" });
        },
      };

      // Location services
      const locationService = {
        getCurrentPosition() {
          return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
              reject(new Error("Geolocation is not supported"));
              return;
            }

            navigator.geolocation.getCurrentPosition(
              (position) => {
                state.currentLocation = {
                  lat: position.coords.latitude,
                  lon: position.coords.longitude,
                  placeId: "temp-place-id",
                };
                resolve(state.currentLocation);
              },
              (error) => reject(error),
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 },
            );
          });
        },
      };

      // Canvas drawing functionality
      const canvasService = {
        init() {
          const canvas = document.getElementById("drawing-canvas");
          if (!canvas) return;

          state.canvas = canvas;
          state.ctx = canvas.getContext("2d");

          let painting = false;

          const startPaint = (e) => {
            painting = true;
            this.draw(e);
          };

          const stopPaint = () => {
            painting = false;
            state.ctx.beginPath();
          };

          this.draw = (e) => {
            if (!painting) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const brushColor = document.getElementById("brush-color").value;
            const brushSize = document.getElementById("brush-size").value;

            state.ctx.lineWidth = brushSize;
            state.ctx.lineCap = "round";
            state.ctx.strokeStyle = brushColor;

            state.ctx.lineTo(x, y);
            state.ctx.stroke();
            state.ctx.beginPath();
            state.ctx.moveTo(x, y);
          };

          canvas.addEventListener("mousedown", startPaint);
          canvas.addEventListener("mouseup", stopPaint);
          canvas.addEventListener("mouseout", stopPaint);
          canvas.addEventListener("mousemove", this.draw);

          // Touch events for mobile
          canvas.addEventListener("touchstart", (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent("mousedown", {
              clientX: touch.clientX,
              clientY: touch.clientY,
            });
            canvas.dispatchEvent(mouseEvent);
          });

          canvas.addEventListener("touchmove", (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent("mousemove", {
              clientX: touch.clientX,
              clientY: touch.clientY,
            });
            canvas.dispatchEvent(mouseEvent);
          });

          canvas.addEventListener("touchend", (e) => {
            e.preventDefault();
            const mouseEvent = new MouseEvent("mouseup", {});
            canvas.dispatchEvent(mouseEvent);
          });
        },

        clear() {
          if (state.canvas && state.ctx) {
            state.ctx.clearRect(0, 0, state.canvas.width, state.canvas.height);
          }
        },

        getDataURL() {
          return state.canvas ? state.canvas.toDataURL() : null;
        },
      };

      // UI Controllers
      const homeController = {
        async init() {
          try {
            await locationService.getCurrentPosition();
            await this.loadNearbyNotes();
            this.setupAdminButton();
          } catch (error) {
            console.error("Error initializing home:", error);
          }
        },

        async loadNearbyNotes() {
          if (!state.currentLocation.lat || !state.currentLocation.lon) return;

          try {
            const notes = await notesAPI.getNearbyNotes(
              state.currentLocation.lat,
              state.currentLocation.lon,
              1000,
            );
            this.renderNotes(notes);
          } catch (error) {
            console.error("Error loading notes:", error);
          }
        },

        renderNotes(notes) {
          const container = document.getElementById("notes-container");
          container.innerHTML = "";

          notes.forEach((note, index) => {
            const noteEl = document.createElement("div");
            noteEl.className = "floating-note";
            noteEl.textContent = "📝";
            noteEl.style.left = Math.random() * 80 + "%";
            noteEl.style.top = Math.random() * 80 + "%";
            noteEl.style.animationDelay = Math.random() * 6 + "s";

            noteEl.addEventListener("click", () => {
              state.currentNoteId = note.id;
              noteViewController.loadNote(note.id);
            });

            container.appendChild(noteEl);
          });
        },

        setupAdminButton() {
          const user = state.currentUser?.user;
          const adminBtn = document.getElementById("admin-btn");
          if (user?.role === "admin") {
            adminBtn.style.display = "block";
          } else {
            adminBtn.style.display = "none";
          }
        },
      };

      const noteViewController = {
        async loadNote(noteId) {
          try {
            const note = await notesAPI.getNoteContent(
              noteId,
              state.currentLocation.lat,
              state.currentLocation.lon,
            );
            this.renderNote(note);
            showScreen("note-view-screen");
          } catch (error) {
            console.error("Error loading note:", error);
            alert("Error loading note: " + error.message);
          }
        },

        renderNote(note) {
          const container = document.getElementById("note-content");
          container.innerHTML = "";

          if (note.content.text) {
            const p = document.createElement("p");
            p.textContent = note.content.text;
            p.style.fontSize = "18px";
            p.style.lineHeight = "1.6";
            p.style.marginBottom = "20px";
            container.appendChild(p);
          }

          if (
            note.content.drawingData &&
            note.content.drawingData !==
              "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxIiBoZWlnaHQ9IjEiPjwvc3ZnPg=="
          ) {
            const img = document.createElement("img");
            img.src = note.content.drawingData;
            img.style.maxWidth = "100%";
            img.style.borderRadius = "12px";
            container.appendChild(img);
          }
        },
      };

      const noteEditorController = {
        init() {
          canvasService.init();
          this.setupModeToggle();
        },

        setupModeToggle() {
          const textMode = document.getElementById("text-mode");
          const drawMode = document.getElementById("draw-mode");
          const textEditor = document.getElementById("text-editor");
          const drawEditor = document.getElementById("draw-editor");

          textMode.addEventListener("click", () => {
            textEditor.style.display = "block";
            drawEditor.style.display = "none";
            textMode.style.background = "#667eea";
            textMode.style.color = "white";
            drawMode.style.background = "none";
            drawMode.style.color = "#667eea";
          });

          drawMode.addEventListener("click", () => {
            textEditor.style.display = "none";
            drawEditor.style.display = "block";
            drawMode.style.background = "#667eea";
            drawMode.style.color = "white";
            textMode.style.background = "none";
            textMode.style.color = "#667eea";
            canvasService.init();
          });
        },

        async saveNote() {
          try {
            await locationService.getCurrentPosition();

            const text = document.getElementById("note-text").value.trim();
            const drawingData = canvasService.getDataURL();

            if (!text && !drawingData) {
              alert("Please add some content to your note");
              return;
            }

            await notesAPI.createNote(
              text,
              drawingData,
              state.currentLocation.lat,
              state.currentLocation.lon,
              state.currentLocation.placeId,
            );

            // Clear the editor
            document.getElementById("note-text").value = "";
            canvasService.clear();

            showScreen("home-screen");
            await homeController.loadNearbyNotes();
          } catch (error) {
            console.error("Error saving note:", error);
            alert("Error saving note: " + error.message);
          }
        },
      };

      const mapController = {
        map: null,

        async init() {
          try {
            await locationService.getCurrentPosition();
            this.initializeMap();
            await this.loadNotesOnMap();
          } catch (error) {
            console.error("Error initializing map:", error);
            alert("Error loading map: " + error.message);
          }
        },

        initializeMap() {
          if (!window.google) {
            console.error("Google Maps not loaded");
            return;
          }

          this.map = new google.maps.Map(document.getElementById("map"), {
            center: {
              lat: state.currentLocation.lat,
              lng: state.currentLocation.lon,
            },
            zoom: 15,
            styles: [
              {
                featureType: "all",
                elementType: "geometry.fill",
                stylers: [{ color: "#f0f0f0" }],
              },
            ],
          });

          // Add user location marker
          new google.maps.Marker({
            position: {
              lat: state.currentLocation.lat,
              lng: state.currentLocation.lon,
            },
            map: this.map,
            title: "Your Location",
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 8,
              fillColor: "#667eea",
              fillOpacity: 1,
              strokeColor: "#fff",
              strokeWeight: 2,
            },
          });
        },

        async loadNotesOnMap() {
          try {
            const notes = await notesAPI.getNearbyNotes(
              state.currentLocation.lat,
              state.currentLocation.lon,
              5000,
            );

            notes.forEach((note) => {
              if (
                note.location &&
                note.location.latitude &&
                note.location.longitude
              ) {
                const marker = new google.maps.Marker({
                  position: {
                    lat: Number(note.location.latitude),
                    lng: Number(note.location.longitude),
                  },
                  map: this.map,
                  title: note.content?.text || "Note",
                  icon: {
                    url:
                      "data:image/svg+xml;charset=UTF-8," +
                      encodeURIComponent(`
                                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30">
                                            <circle cx="15" cy="15" r="12" fill="#ffd54f" stroke="#fff" stroke-width="2"/>
                                            <text x="15" y="20" font-family="Arial" font-size="14" text-anchor="middle" fill="#333">📝</text>
                                        </svg>
                                    `),
                    scaledSize: new google.maps.Size(30, 30),
                    anchor: new google.maps.Point(15, 15),
                  },
                });

                marker.addListener("click", () => {
                  state.currentNoteId = note.id;
                  noteViewController.loadNote(note.id);
                });
              }
            });
          } catch (error) {
            console.error("Error loading notes on map:", error);
          }
        },
      };

      const adminController = {
        async init() {
          await this.loadUsers();
          await this.loadNotes();
        },

        async loadUsers() {
          try {
            const users = await adminAPI.getAllUsers();
            const container = document.getElementById("admin-users");
            container.innerHTML = "";

            users.forEach((user) => {
              const userEl = document.createElement("div");
              userEl.className = "admin-item";
              userEl.innerHTML = `
                            <div>
                                <strong>${user.email}</strong>
                                <span style="color: #666; margin-left: 10px;">(${user.role})</span>
                            </div>
                            <button class="btn-danger" onclick="adminController.deleteUser('${user.id}')">Delete</button>
                        `;
              container.appendChild(userEl);
            });
          } catch (error) {
            console.error("Error loading users:", error);
            document.getElementById("admin-users").innerHTML =
              "<p>Error loading users</p>";
          }
        },

        async loadNotes() {
          try {
            const notes = await adminAPI.getAllNotes();
            const container = document.getElementById("admin-notes");
            container.innerHTML = "";

            notes.forEach((note) => {
              const noteEl = document.createElement("div");
              noteEl.className = "admin-item";
              noteEl.innerHTML = `
                            <div>
                                <p>${note.content.text ? note.content.text.substring(0, 50) + "..." : "Drawing note"}</p>
                                <small style="color: #666;">by ${note.userId}</small>
                            </div>
                            <button class="btn-danger" onclick="adminController.deleteNote('${note.id}')">Delete</button>
                        `;
              container.appendChild(noteEl);
            });
          } catch (error) {
            console.error("Error loading notes:", error);
            document.getElementById("admin-notes").innerHTML =
              "<p>Error loading notes</p>";
          }
        },

        async deleteUser(userId) {
          if (!confirm("Are you sure you want to delete this user?")) return;

          try {
            await adminAPI.deleteUser(userId);
            await this.loadUsers();
          } catch (error) {
            console.error("Error deleting user:", error);
            alert("Error deleting user: " + error.message);
          }
        },

        async deleteNote(noteId) {
          if (!confirm("Are you sure you want to delete this note?")) return;

          try {
            await adminAPI.deleteNoteAsAdmin(noteId);
            await this.loadNotes();
          } catch (error) {
            console.error("Error deleting note:", error);
            alert("Error deleting note: " + error.message);
          }
        },
      };

      // Initialize Google Maps
      window.initMap = function () {
        console.log("Google Maps loaded");
      };

      // Event listeners
      document.addEventListener("DOMContentLoaded", function () {
        // Update time
        const updateTime = () => {
          const now = new Date();
          document.getElementById("time").textContent = now.toLocaleTimeString(
            "en-US",
            { hour: "2-digit", minute: "2-digit" },
          );
        };
        updateTime();
        setInterval(updateTime, 60000);

        // Auth form handlers
        document
          .getElementById("login-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value;

            try {
              await authAPI.signin(email, password);
              showScreen("home-screen");
              await homeController.init();
            } catch (error) {
              showError("login-error", error.message);
            }
          });

        document
          .getElementById("signup-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("signup-email").value.trim();
            const password = document.getElementById("signup-password").value;

            try {
              await authAPI.signup(email, password);
              alert("Account created successfully! Please sign in.");
              showScreen("login-screen");
            } catch (error) {
              showError("signup-error", error.message);
            }
          });

        document
          .getElementById("forgot-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("forgot-email").value.trim();

            try {
              await authAPI.forgotPassword(email);
              alert(
                "If an account with that email exists, a password reset link has been sent.",
              );
              showScreen("login-screen");
            } catch (error) {
              showError("forgot-error", error.message);
            }
          });

        // Navigation handlers
        document.getElementById("show-signup").addEventListener("click", () => {
          showScreen("signup-screen");
        });

        document.getElementById("show-forgot").addEventListener("click", () => {
          showScreen("forgot-screen");
        });

        document
          .getElementById("back-to-login")
          .addEventListener("click", () => {
            showScreen("login-screen");
          });

        document
          .getElementById("back-to-login-2")
          .addEventListener("click", () => {
            showScreen("login-screen");
          });

        document
          .getElementById("show-map")
          .addEventListener("click", async () => {
            showScreen("map-screen");
            await mapController.init();
          });

        document
          .getElementById("show-profile")
          .addEventListener("click", () => {
            showScreen("profile-screen");
          });

        document
          .getElementById("admin-btn")
          .addEventListener("click", async () => {
            showScreen("admin-screen");
            await adminController.init();
          });

        document
          .getElementById("new-note-btn")
          .addEventListener("click", () => {
            showScreen("note-editor-screen");
            noteEditorController.init();
          });

        // Back navigation
        document
          .getElementById("back-from-map")
          .addEventListener("click", () => {
            showScreen("home-screen");
          });

        document
          .getElementById("back-from-editor")
          .addEventListener("click", () => {
            showScreen("home-screen");
          });

        document
          .getElementById("back-from-note")
          .addEventListener("click", () => {
            showScreen("home-screen");
          });

        document
          .getElementById("back-from-profile")
          .addEventListener("click", () => {
            showScreen("home-screen");
          });

        document
          .getElementById("back-from-admin")
          .addEventListener("click", () => {
            showScreen("home-screen");
          });

        // Note editor actions
        document.getElementById("save-note").addEventListener("click", () => {
          noteEditorController.saveNote();
        });

        document
          .getElementById("clear-canvas")
          .addEventListener("click", () => {
            canvasService.clear();
          });

        // Note actions
        document
          .getElementById("delete-note")
          .addEventListener("click", async () => {
            if (!confirm("Are you sure you want to delete this note?")) return;

            try {
              await notesAPI.deleteNote(
                state.currentNoteId,
                state.currentLocation.lat,
                state.currentLocation.lon,
              );
              showScreen("home-screen");
              await homeController.loadNearbyNotes();
            } catch (error) {
              console.error("Error deleting note:", error);
              alert("Error deleting note: " + error.message);
            }
          });

        // Profile actions
        document.getElementById("logout-btn").addEventListener("click", () => {
          state.currentUser = null;
          showScreen("login-screen");
        });

        document
          .getElementById("delete-account-btn")
          .addEventListener("click", async () => {
            const password = prompt(
              "Enter your current password to confirm account deletion:",
            );
            if (!password) return;

            if (
              !confirm(
                "Are you sure you want to delete your account? This cannot be undone.",
              )
            )
              return;

            try {
              await authAPI.deleteAccount(password);
              alert("Account deleted successfully.");
              state.currentUser = null;
              showScreen("login-screen");
            } catch (error) {
              console.error("Error deleting account:", error);
              alert("Error deleting account: " + error.message);
            }
          });

        // Initialize app
        console.log("PickMi SPA initialized");
      });
    </script>
  </body>
</html>
